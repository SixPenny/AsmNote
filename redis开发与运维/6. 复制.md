## 配置

1. 每个从节点只能有一个主节点，主节点可以有多个从节点，配置从节点有三种方式
    1. 配置文件中加入 `slaveof {masterHost} {masterPort}`
    2. 启动redis-server 时加入 `--slaveof {masterHost} {masterPort}`
    3. 直接使用命令`slave of {masterHost} {masterPort}`
    4. 都是在从节点上执行
2. 使用`slaveof no one` 断开与主节点复制关系，断开并不会改变现有数据
3. `slaveof {masterHost} {masterPort}` 可以实现切换主节点操作，切主后从节点会删除所有数据然后从新主节点复制数据
4. 主节点可以设置 `requirepass` 来开启密码校验，从节点开启 `masterauth` 来通过校验
5. 从节点默认是只读的 `slave-read-only=yes`, 从节点的修改无法同步到主节点，所以保持默认就好
6. 主从复制有延迟，redis 提供 `repl-disable-tcp-nodelay` 参数来控制 tcp 传输

## 拓扑

1. 一主一从
    1. 可以只在从节点上开启 AOF
2. 一主多从
    1. 可以通过从节点读数据来减轻主节点压力
    2. 写过高会导致过度消耗网络带宽
3. 树状主从结构
    1. 从节点复制主节点数据，从节点又作为主节点继续向下复制
    2. 当从节点太多时，可以使用树状结构来减轻主节点压力

## 原理

### 复制过程

1. ![主从节点复制流程图](https://note.youdao.com/yws/public/resource/32ea1858ff2e15f7e155e45799a1c696/xmlnote/2E6C5CF261EA4B028F7297FBAB481409/23593)
2. 1）通过`info replication` 查看复制信息
3. 2）slave 节点通过定时任务维护复制逻辑，当定时任务发现存在新的主节点后，会与该节点建立网络连接，如果无法连接，会无限重试直到成功或取消复制
4. 3）ping 命令检测连接是否可用，如果没有收到回复，从节点会断开复制连接，定制任务下次会重连
5. 4）如果master 开启了权限验证
6. 5）第一次复制主节点会把所有数据发给从节点，耗时较长
7. 6）主节点持续将命令发给从节点

### 数据同步

1. 全量复制：一般只在初次复制时使用
2. 部分复制：处理在主从复制发生网络闪断等原因造成的数据丢失，从节点重连后，主节点补发数据给从节点。
    1. 复制偏移量，从节点在接收到主节点发来的命令后，会累加自身偏移量，同时每秒钟上报自身偏移量给主节点，主节点保存从节点偏移量，并且在每次处理完写入命令后更新自身偏移量`master_repl_offset`
    2. 复制积压缓冲区。是主节点上固定长度的队列，从节点连接时被创建。用于部分复制和复制命令丢失的情况
    3. 主节点运行ID。 启动时分配，用于唯一识别 Redis 节点

### 全量复制

1. `psync` 全量复制过程，发送命令为`psync {runId} {offset}`
2. 发送`psync` 命令进行复制，由于是第一次复制， runId 和 offset 都不知道，因此发送`psync ? -1`
3. 主节点回复 `+FULLRESYNC` 响应
4. 从节点接收主节点响应数据保存 runId 和 offset
5. 主节点执行 `bgsave` 保存rdb 文件到本地，
6. 主节点发送 rdb 文件给从节点，接收到后作为从节点的数据文件
7. rdb 文件传送期间，主节点依然响应写命令，数据会保存到复制客户端缓冲区内，默认配置60s内缓冲区持续大于64M 或超过256M，主节点直接关闭复制连接
8. 从节点接收完数据后会清空自身数据
9. 从节点开始加载 rdb 文件
10. 从节点加载完成后，如果配置了 aof，会理解做 bgwriteaof 操作

### 部分复制

1. 当从节点正在复制主节点时，如果发生网络闪断或命令丢失，从节点通过命令 `psync {runId} {offset}` 请求主节点补发丢失的数据。
2. 当主从节点发生网络闪断，超过 repl-timeout 时间后，主节点断开复制连接
3. 主节点响应的写命令写入复制缓冲区内，默认1MB
4. 连接恢复后，从节点发送命令给主节点要求进行部分复制操作
5. 主节点比较 runId，如果一致说明之前复制的是本节点，然后根据 offset 在缓冲区内查找，如果偏移量之后的数据在缓冲区内则说明可以进行部分复制，发送`+CONTINUE` 响应
6. 主节点根据偏移量把缓冲区内的数据发送给从节点，主从复制进入正常状态

### 心跳

1. 主从节点彼此都有心跳机制
2. 主节点默认10s 发送一次吃ping命令。`repl-ping-slave-period` 配置控制间隔时间
3. 从节点每隔1s 发送 `replconf ack {offset}` 命令上报复制偏移量

### 异步复制

1. 主节点发送命令的过程是异步完成
2. 主从节点会有数据延迟

## 开发与运维问题

### 读写分离

1. 读多写少的情况可以使用从节点分摊压力
2. 可能遇到的问题
    1. 复制数据延迟
    2. 读到过期数据
    3. 从节点故障

### 主从配置不一致

1. 有些配置可以不一致，但是内存相关配置必须一致，如 maxmemory， hash-max-ziplist-entries等参数

### 规避全量复制

1. 第一次建立复制，避免不了全量复制，因此可以选择在低峰期建立从节点
2. 节点运行ID 不匹配，可选用自动故障转移的哨兵方案或集群方案
3. 复制缓冲区不足。当offset 不在缓冲区内时，部分复制退化到全量复制，因此合理分配缓冲区大小。

### 规避复制风暴

1. 复制风暴是指短时间内大量从节点对同一主节点或同一机器的多个主节点发起全量复制的过程
2. 单一主节点复制风暴：减少从节点数量或采用树状复制结构
3. 单机器复制风暴：主节点尽量分布在不同机器上，或提供故障转移功能

