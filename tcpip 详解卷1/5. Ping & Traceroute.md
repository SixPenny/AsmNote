## Ping 程序

1. 对于请求和应答的 ICMP报文，一定要有标识符和序号
    1. 标识符通常为发送进程号
    2. 序列号初始化为0，每发送一个包加1
    3. 回显必须将标识符，序列号，选项数据全部返回

2. Ping 报文格式

```text

------------------------------------------------------------
| Type = 8    | Code = 0      | Checksum                   |
------------------------------------------------------------
| Identifier                  |Sequence Number             |
------------------------------------------------------------
| Payload                                                  |
---------------------------------------––––––––––––---------
```

3. 使用 -R 选项记录路由
    1. 使用 -R 选项后，会开启IP选项 RecordRoute
    2. 经过的路由记录在IP首部中，由于 IP 首部最长为60字节，因此记录路由数量有限，最多9个
    3. 格式，ptr 为尾部指针，code，len，ptr各占1字节，ip 占4字节
    ```
    |code|len|ptr| ip1  | ip2  |.....| ip9 |
    ```
    4. 记录的是路由的出口地址，主机记录自身地址

## Traceroute 程序

1. IP 记录路由选项由于首部长度限制，最多只能记录9个，因此不建议使用。
2. TTL 可以当作一个跳站计数器
    1. 路由器不转发 TTL 为0或1 的数据报，直接丢弃
    2. 路由器丢弃后会回发一个 ICMP 超时报文给源站
    3. 报文中的IP 源地址就是路由器的 IP地址（入口地址）
    4. 到达目的主机后，报文被进程接收，就检测不到何时结束。因此tranceroute 选用了一个 UDP 不可能使用到的端口，这样在报文到达后，目的主机会发回一个 ICMP 端口不可打错误。traceroute 据此可判断报文到达目的主机。
3. IP 源站选路
    1. 严格的源路由选择(SSRR)。发送端IP 报文指明所必须采用的确切路由，如果路由器发现下一跳不在其直接相连的网络上，则返回一个源站路由失败的 ICMP 差错报文
    2. 宽松的源站路由选择(LSRR)。 发送端指明一个数据报经过路由的清单，但是在清单的任意两个地址之间可以通过其他路由器。
    3. traceroute 使用 -g 指明宽松源站选路，-G 指明严格源站选路
4. 使用宽松源站选路，可以查看报文在两个方向上的路由路径
    1. 使用 traceroute 自己，-g 指明必须经过的路由，那么包路径为 `self --> 发出路径 --> 源站路由 --> 返回路径 --> self`


## Caution

1. 现在很多防火墙都加了控制，不允许 ICMP 报文传送，因此 ping 与 traceroute 程序很多时候都不可用
